<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNPJ List</title>
    <link rel="stylesheet" href="static/css/style.css">
</head>

<body>
    <h2>Digite um CNPJ por linha:</h2>
    <p>Exemplo do formato: 79.227.963/0001-82</p>
    <!-- O textarea com name 'lista de cnpjs' -->
    <textarea class="cnpjs" name="lista de cnpjs"></textarea><br>
    <button onclick="enviarCNPJs()">Gerar arquivo excel</button>

    <div id="logs"></div>

    <!-- Link de download que será exibido após o sucesso -->
    <div id="download-container" style="display:none;">
        <p>O arquivo foi gerado com sucesso! Você pode baixar o arquivo aqui:</p>
        <a id="download-link" href="" download>
            <button id="download-btn">Baixar o arquivo gerado</button>
        </a>
    </div>

    <div id="modalMensagem" class="modal">
        <div class="modal-conteudo">
            <span class="fechar" onclick="fecharModal()">&times;</span>
            <p id="mensagemModal"></p>
        </div>
    </div>

    <script>
        function enviarCNPJs() {
            var cnpjs = document.querySelector('.cnpjs').value;
            if (!cnpjs) {
                alert('Por favor, insira pelo menos um CNPJ!');
                return;
            }

            var cnpjLista = cnpjs.split('\n');

            fetch('https://fpsi52x1f1.execute-api.us-east-2.amazonaws.com/prod/receber-cnpjs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': 'https://main.d1oye14rstulb5.amplifyapp.com/'
                },
                body: JSON.stringify({ cnpjs: cnpjLista })
            })
                .then(response => response.json())
                .then(data => {
                    console.log('CNPJs enviados:', data);
                    alert('Arquivo gerado: ' + data.arquivo);

                    // Exibir logs na tela
                    let logContainer = document.getElementById('logs');
                    logContainer.innerHTML = '';  // Limpar logs anteriores
                    data.logs.forEach(log => {
                        let logElement = document.createElement('p');
                        logElement.textContent = log;
                        logContainer.appendChild(logElement);
                    });

                    // Exibir o link de download
                    let downloadUrl = data.url;  // Usando a URL fornecida pela resposta do backend

                    // Atualiza o link de download
                    document.getElementById("download-link").href = downloadUrl;
                    document.getElementById("download-container").style.display = 'block';
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao enviar os dados');
                });
        }

        function exibirMensagem(texto) {
            document.getElementById("mensagemModal").innerHTML = texto;
            document.getElementById("modalMensagem").style.display = "block";
        }

        function fecharModal() {
            document.getElementById("modalMensagem").style.display = "none";
        }
    </script>
</body>

</html>